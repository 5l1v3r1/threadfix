var myAppModule = angular.module('threadfix')

myAppModule.controller('VulnerabilityDetailPageController', function ($scope, $window, $http, $rootScope, tfEncoder, $modal, $log) {

    $scope.vulnId  = $window.location.pathname.match(/([0-9]+)$/)[0];
    $scope.teamId = $window.location.pathname.match(/([0-9]+)/)[0];
    $scope.appId = $window.location.pathname.match(/([0-9]+)/)[1];
    $scope.currentUrl = "/organizations/" + $scope.teamId + "/applications/" + $scope.appId + "/vulnerabilities/" + $scope.vulnId;


    $scope.$on('rootScopeInitialized', function() {
        $http.get(tfEncoder.encode($scope.currentUrl + '/table')).
            success(function(data, status, headers, config) {

                if (data.success) {
                    $scope.vulnerability = data.object;

                } else {
                    $scope.errorMessage = "Failure. Message was : " + data.message;
                }
            }).
            error(function(data, status, headers, config) {
                $scope.errorMessage = "Failed to retrieve waf list. HTTP status was " + status;
            });
    });

    $scope.statistic = function() {
        if ($scope.showStatistic) {
            $scope.showStatistic = false;
            $scope.statisticText = 'Show Statistics';
        } else {
            $scope.showStatistic = true;
            $scope.statisticText = 'Hide Statistics';
        }
    };

    $scope.openCommentModal = function() {

        var modalInstance = $modal.open({
            templateUrl: 'vulnCommentForm.html',
            controller: 'GenericModalController',
            resolve: {
                url: function() {
                    return tfEncoder.encode($scope.currentUrl + "/addComment");
                },
                object: function () {
                    return $scope.vulnerability;
                },
                buttonText: function() {
                    return "Add Comment";
                }
            }
        });

        modalInstance.result.then(function (comments) {
            $scope.successMessage = "Successfully added new comment";
            $scope.vulnerability.vulnerabilityComments = comments;
        }, function () {
            $log.info('Modal dismissed at: ' + new Date());
        });
    };

    $scope.openDocModal = function() {

        var modalInstance = $modal.open({
            templateUrl: 'vulnDocForm.html',
            controller: 'GenericModalController',
            resolve: {
                url: function() {
                    return tfEncoder.encode($scope.currentUrl + "/addComment");
                },
                object: function () {
                    return $scope.vulnerability;
                },
                buttonText: function() {
                    return "Add Comment";
                }
            }
        });

        modalInstance.result.then(function (comments) {

        }, function () {
            $log.info('Modal dismissed at: ' + new Date());
        });
    };

    $scope.deleteDoc = function(document) {

    };
    $scope.downloadDoc = function(document) {

    };
    $scope.viewDoc = function(document) {

    };

});
