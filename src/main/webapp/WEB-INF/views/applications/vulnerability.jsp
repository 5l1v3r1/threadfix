<%@ include file="/common/taglibs.jsp"%>

<head>
	<title>Vulnerability Details</title>
	<script type="text/javascript" src="<%=request.getContextPath()%>/scripts/vuln-comments.js"></script>
	<meta name="heading" content="<fmt:message key='mainMenu.heading'/>" />
	<script type="text/javascript" src="<%=request.getContextPath()%>/scripts/toggle.js"></script>
</head>

<body id="apps">
	<spring:url value="/organizations/{orgId}" var="teamUrl">
		<spring:param name="orgId" value="${ vulnerability.application.organization.id }" />
	</spring:url>
	<spring:url value="/organizations/{orgId}/applications/{applicationId}" var="applicationUrl">
		<spring:param name="orgId" value="${ vulnerability.application.organization.id }" />
		<spring:param name="applicationId" value="${ vulnerability.application.id }" />
	</spring:url>
	
	<ul class="breadcrumb">
	    <li><a href="<spring:url value="/"/>">Teams</a> <span class="divider">/</span></li>
	    <li><a href="${ fn:escapeXml(teamUrl) }"><c:out value="${ vulnerability.application.organization.name }"/></a> <span class="divider">/</span></li>
	    <li><a href="${ fn:escapeXml(applicationUrl) }"><c:out value="${ vulnerability.application.name }"/></a><span class="divider">/</span></li>
	    <li class="active">Vulnerability <c:out value="${ vulnerability.id }"/></li>
    </ul>
	
	<h2>Vulnerability Details
	<span style="font-size:10pt;">
		<c:if test="${ canModifyVulnerabilities }">
			<c:if test="${ vulnerability.active }">
				<spring:url
					value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/close"
					var="closeUrl">
					<spring:param name="applicationId"
						value="${ vulnerability.application.id }" />
					<spring:param name="vulnerabilityId" value="${ vulnerability.id }" />
				</spring:url>
				<a id="closeVulnerabilityLink" href="${ fn:escapeXml(closeUrl) }">Close Vulnerability</a>
			</c:if>
			<c:if test="${ not vulnerability.active }">
				<spring:url
					value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/open"
					var="closeUrl">
					<spring:param name="applicationId"
						value="${ vulnerability.application.id }" />
					<spring:param name="vulnerabilityId" value="${ vulnerability.id }" />
				</spring:url>
				<a id="openVulnerabilityLink" href="${ fn:escapeXml(closeUrl) }">Open Vulnerability</a>
			</c:if>
			|
			<c:if test="${ not vulnerability.isFalsePositive }">
				<spring:url
					value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/markFalsePositive"
					var="closeUrl">
					<spring:param name="applicationId"
						value="${ vulnerability.application.id }" />
					<spring:param name="vulnerabilityId" value="${ vulnerability.id }" />
				</spring:url>
				<a id="markFalsePositiveLink" href="${ fn:escapeXml(closeUrl) }">Mark as False Positive</a>
			</c:if>
			<c:if test="${ vulnerability.isFalsePositive }">
				<spring:url
					value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/markNotFalsePositive"
					var="closeUrl">
					<spring:param name="applicationId"
						value="${ vulnerability.application.id }" />
					<spring:param name="vulnerabilityId" value="${ vulnerability.id }" />
				</spring:url>
				<a id="unmarkFalsePositiveLink" href="${ fn:escapeXml(closeUrl) }">Unmark False Positive</a>
			</c:if>
			<c:if test="${ not empty vulnerability.defect }">
				|
				<spring:url value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/defect" var="defectUrl">
					<spring:param name="applicationId" value="${ vulnerability.application.id }"/>
					<spring:param name="vulnerabilityId" value="${ vulnerability.id }"/>
				</spring:url>
				<a id="viewDefectLink" href="${ fn:escapeXml(defectUrl) }">View Defect</a>
			</c:if>
		</c:if>
	</span>
	</h2>
	
	<div id="helpText">
		This page lists information about a specific Vulnerability.
	</div>
	
	<div class="left-tile">
		<h4>Basic Information</h4>
	
		<spring:url value="http://cwe.mitre.org/data/definitions/{vulnId}.html" var="cweUrl">
			<spring:param name="vulnId" value="${ vulnerability.genericVulnerability.id }" />
		</spring:url>
		
		<table class="dataTable">
			<tr>
				<td class="bold">CWE Vulnerability</td>
				<td class="inputValue"><c:out value="${ vulnerability.genericVulnerability.name }"/>
					(<a id="cweLink" href="${ fn:escapeXml(cweUrl) }" target="_blank">CWE Entry for CWE-<c:out value="${ vulnerability.genericVulnerability.id }"/></a>)
				</td>
			</tr>
			<tr>
				<td class="bold">Severity</td>
				<td class="inputValue"><c:out value="${ vulnerability.genericSeverity.name }"/></td>
			</tr>
			<tr>
				<td class="bold">Host</td>
				<td id="host" class="inputValue"><c:out value="${ surfaceLocation.host }" /></td>
			</tr>
			<tr>
				<td class="bold">Path</td>
				<td id="path" class="inputValue"><c:out value="${ surfaceLocation.path }" /></td>
			</tr>
			<tr>
				<td class="bold">Protocol</td>
				<td id="protocol" class="inputValue"><c:out
						value="${ surfaceLocation.protocol }" /></td>
			</tr>
			<tr>
				<td class="bold">Port</td>
				<td id="port" class="inputValue"><c:if
						test="${ surfaceLocation.port != -1 }">
						<c:out value="${ surfaceLocation.port }" />
					</c:if></td>
			</tr>
			<tr>
				<td class="bold">Query</td>
				<td id="query" class="inputValue"><c:out
						value="${ surfaceLocation.query }" /></td>
			</tr>
			<tr>
				<td class="bold">Parameter</td>
				<td id="parameter" class="inputValue"><c:out
						value="${ surfaceLocation.parameter }" /></td>
			</tr>
		</table>
	</div>
	<div id="right-tile">
		<c:if test="${not empty timeArray}">
			<h4>Status History</h4>
			<table class="table table-striped">
				<thead>
					<tr>
						<th class="first">Event</th>
						<th class="middle">Date</th>
						<th class="last"># Days</th>
					</tr>
				</thead>
				<tbody>
					<tr class="bodyRow">
						<td>Opened</td>
						<td id="vulnOpenTime"><fmt:formatDate value="${ vulnerability.openTime.time }"
								type="both" dateStyle="short" timeStyle="medium" /></td>
						<td><c:out value="${timeArray[0]}" /></td>
					</tr>
					<tr class="bodyRow">
						<td>WAF rule generated</td>
						<td id="vulnWafRuleTime"><fmt:formatDate
								value="${ vulnerability.wafRuleGeneratedTime.time }" type="both"
								dateStyle="short" timeStyle="medium" /></td>
						<td><c:out value="${timeArray[1]}" /></td>
					</tr>
					<tr class="bodyRow">
						<td>Submitted to tracker</td>
						<td id="vulnDefectSubmittedTime"><fmt:formatDate
								value="${ vulnerability.defectSubmittedTime.time }" type="both"
								dateStyle="short" timeStyle="medium" /></td>
						<td><c:out value="${timeArray[2]}" /></td>
					</tr>
					<tr class="bodyRow">
						<td>Marked as closed by tracker</td>
						<td id="vulnClosedInTrackerTime"><fmt:formatDate
								value="${ vulnerability.defectClosedTime.time }" type="both"
								dateStyle="short" timeStyle="medium" /></td>
						<td><c:out value="${timeArray[3]}" /></td>
					</tr>
					<tr class="bodyRow">
						<td><c:choose>
								<c:when test="${vulnerability.foundByScanner}">Found closed by scanner</c:when>
								<c:otherwise>Marked closed</c:otherwise>
							</c:choose></td>
						<td id="vulnCloseTime"><fmt:formatDate value="${ vulnerability.closeTime.time }"
								type="both" dateStyle="short" timeStyle="medium" /></td>
						<td><c:out value="${timeArray[4]}" /></td>
					</tr>
				</tbody>
			</table>
		</c:if>
	</div>
	
	<c:set var="editVisible" value="false"/>
	
	<c:forEach var="finding" items="${ vulnerability.findings }">
	    <c:if test="${ finding.scan.applicationChannel.channelType.name == 'Manual'}">
			<c:set var="editVisible" value="true"/>
		</c:if>
	</c:forEach>

	<c:if test="${not empty vulnerability.findings}">
		<h3>Findings</h3>
		<table class="table table-striped sortable" id="2">
			<thead>
				<tr>
					<th class="first">Scanner Name</th>
					<th>Severity</th>
					<th>Vulnerability Type</th>
					<th>Path</th>
					<th>Parameter</th>
					<c:if test="${ editVisible }">				
						<th>Number Merged Results</th>
						<th class="last">Edit</th>
					</c:if>
					<c:if test="${ not editVisible }">				
						<th class="last">Number Merged Results</th>
					</c:if>
				</tr>
			</thead>
			<tbody>
				<c:forEach var="finding" items="${ vulnerability.findings }" varStatus="status">
					<tr class="bodyRow">
						<td id="scannerName${ status.count }"><c:out
								value="${ finding.scan.applicationChannel.channelType.name }" />
						</td>
						<td id="severityName${ status.count }"><c:out value="${ finding.channelSeverity.name }" /></td>
						<td id="vulnName${ status.count }"><spring:url value="../scans/{scanId}/findings/{findingId}" var="findingUrl">
								<spring:param name="scanId" value="${ finding.scan.id }" />
								<spring:param name="findingId" value="${ finding.id }" />
							</spring:url> <a href="${ fn:escapeXml(findingUrl) }"> <c:out
									value="${ finding.channelVulnerability.name }" />
						</a></td>
						<td id="path${ status.count }"><c:out value="${ finding.surfaceLocation.path }" /></td>
						<td id="parameter${ status.count }"><c:out value="${ finding.surfaceLocation.parameter }" />
						</td>
						<td id="numResults${ status.count }"><c:out value="${ finding.numberMergedResults }" /></td>
						<c:if test="${ editVisible }">
							<td>
								<c:if test="${ finding.scan.applicationChannel.channelType.name == 'Manual'}">
									<spring:url value="../manual/{findingId}" var="editUrl">
										<spring:param name="findingId" value="${ finding.id }" />
									</spring:url> 
									<a id="editLink" href="${ fn:escapeXml(editUrl) }">Edit</a>
								</c:if>
							</td>
						</c:if>
					</tr>
				</c:forEach>
			</tbody>
		</table>
	</c:if>

	<c:if test="${not empty staticFindingList}">
		<h3>Data Flow Variants</h3>
		<c:forEach var="finding" items="${staticFindingList}" varStatus="findingStatus">
			<c:if test="${ not empty finding.dataFlowElements }">
				<a href="javascript:toggleid('<c:out value="${ finding.id }"/>');">Toggle
					finding <c:out value="${ finding.id }" /> data flow (Elements: <c:out
						value="${ fn:length(finding.dataFlowElements) }" />)
				</a>
				<br />

				<div id='<c:out value="${ finding.id }"/>' style="display: none;">
					<h3>
						Finding
						<c:out value="${ finding.id }" />
						Data Flow
					</h3>
					<c:forEach var="dataFlowElement" varStatus="dataFlowElementStatus"
						items="${finding.dataFlowElements}">
						<table class="dataTable">
							<tr>
								<td>File Name</td>
								<td id="finding${ findingStatus.count }SourceFileName${ dataFlowElementStatus.count }" 
									class="inputValue"><c:out value="${ dataFlowElement.sourceFileName }" /></td>
							</tr>
							<tr>
								<td>Line number</td>
								<td id="finding${ findingStatus.count }LineNumber${ dataFlowElementStatus.count }" 
									class="inputValue"><c:out value="${ dataFlowElement.lineNumber }" /></td>
							</tr>
							<tr>
								<td>Line text</td>
								<td id="finding${ findingStatus.count }LineText${ dataFlowElementStatus.count }" 
									class="inputValue"><c:out value="${ dataFlowElement.lineText }" /></td>
							</tr>
							<tr>
								<td></td>
							</tr>
						</table>
					</c:forEach>
				</div>
			</c:if>
		</c:forEach>
	</c:if>

	<c:if
		test="${ not empty singleStaticFinding and not empty singleStaticFinding.dataFlowElements }">
		<h3>Data Flow</h3>
		<c:forEach var="dataFlowElement" varStatus="status"
			items="${singleStaticFinding.dataFlowElements}">
			<table class="dataTable">
				<tr>
					<td>File Name</td>
					<td id="sourceFileName${ status.count }" class="inputValue"><c:out
							value="${ dataFlowElement.sourceFileName }" /></td>
				</tr>
				<tr>
					<td>Line number</td>
					<td id="lineNumber${ status.count }" class="inputValue"><c:out
							value="${ dataFlowElement.lineNumber }" /></td>
				</tr>
				<tr>
					<td>Line text</td>
					<td id="lineText${ status.count }" class="inputValue"><c:out
							value="${ dataFlowElement.lineText }" /></td>
				</tr>
				<tr>
					<td></td>
				</tr>
			</table>
		</c:forEach>
	</c:if>

	<br/>
	
	<div id="commentDiv${ vulnerability.id }">
		<%@ include file="/WEB-INF/views/applications/vulnComments.jsp" %>
	</div>
</body>

